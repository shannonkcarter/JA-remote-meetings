---
title: "JA Remote Meeting Analysis"
author: "Shannon Carter"
date: "August 28, 2020"

output: 
  html_document:
    toc: true
    toc_float:
      collapsed: true
      smooth_scroll: true
---

<style type="text/css">
body { font-size: 16px; line-height:140%: font-family: 'Libre Franklin', sans-serif; color:#333; }
.tocify { font-size: 12px; border:none!important; border-radius:0px!important; }
h2 { font-size:30px; }
#TOC {
  background: url("https://www.januaryadvisors.com/wp-content/uploads/2018/07/ja-logo-horizontal.svg");
  background-size: 80%;
  padding-bottom: 40px !important;
  background-repeat: no-repeat;
  background-position: left bottom;
}
.list-group-item.active, .list-group-item.active:focus, .list-group-item.active:hover {
background-color: rgb(49,156,244,0.8);
border-color: #319cf4;
}
</style>

```{r setup, include=FALSE}

knitr::opts_chunk$set(echo = TRUE)
rm(list = ls(all = T))

# load packages
library(tidyverse)
library(highcharter)
library(janitor)
library(here)
library(googlesheets4)
library(config)
library(aws.s3)

mytheme <- theme_bw(base_size = 15, base_family = "Franklin Gothic Medium") +
  theme(legend.text = element_text(size = 10),
        legend.title = element_text(size = 11),
        text = element_text(size = 14),     
        axis.title = element_text(size = 12),
        axis.text  = element_text(size = 10, family = "Consolas"),
        panel.grid = element_blank())

# load data
pw <- config::get("aws", file = "config.yml")

Sys.setenv("AWS_ACCESS_KEY_ID" = pw$AWS_ACCESS_KEY_ID,
           "AWS_SECRET_ACCESS_KEY" =  pw$AWS_SECRET_ACCESS_KEY,
           "AWS_DEFAULT_REGION" = pw$AWS_DEFAULT_REGION
)


loadData <- function() {
  df <- s3readRDS(
    bucket = "standupapp",
    object = "standapp-data.rds"
  )
  return(df)
}

df <- loadData()
# df <- googlesheets4::read_sheet("https://docs.google.com/spreadsheets/d/1lcaht7ezzJxZ5gvh7A5TF9iZkWGAVQ4hJ9yXXH_6dnY/edit#gid=851427512", sheet = "clean-data", na = c("NA", ""))
```

```{r}
hist <- df %>% 
  pivot_longer(cols = Brian:Zach, names_to = "person", values_to = "order") %>%
  filter(date < "2021-02-08") %>% 
  mutate(order = as.numeric(order)) %>% 
  filter(person != "Hala" & person != "Divine" & person != "Zach") %>%
  filter(order < 9) %>% 
  ggplot(aes(x = order)) +
  geom_bar(stat = "count", fill = "dodgerblue") +
  facet_wrap(~person) +
  mytheme +
  scale_x_continuous(breaks = seq(1, 8, 1))
hist

hist2 <- df %>% 
  pivot_longer(cols = Brian:Zach, names_to = "person", values_to = "order") %>% 
  filter(person != "Hala" & person != "Divine" & person != "Zach") %>% 
  filter(order < 9) %>% 
  ggplot(aes(x = order, fill = person)) +
  geom_bar(stat = "count", position = 'dodge') +
  mytheme +
  scale_x_continuous(breaks = seq(1, 8, 1))
hist2
```

```{r}

getMode <- function(x) {
  ux <- na.omit(unique(x) )
 tab <- tabulate(match(x, ux)); ux[tab == max(tab) ]
}
brian_mode <- getMode(df$Brian)
emi_mode <- getMode(df$Emi)
summary <- df %>% 
  summarize(Brian = getMode(Brian)[1],
            Carly = getMode(Carly)[1],
            David = getMode(David)[1],
            Emi = getMode(Emi)[1],
            Jeff = getMode(Jeff)[1],
            Kelsey = getMode(Kelsey)[1],
            Marissa = getMode(Marissa)[1],
            Shannon = getMode(Shannon)[1]) %>% 
  pivot_longer(cols = Brian:Shannon, names_to = "person", values_to = "mode") %>% 
  left_join(call_on)

call_on <- df_long %>% 
  filter(!is.na(person_called_on)) %>% 
  group_by(person) %>% 
  arrange(desc(n)) %>% 
  slice_head(n = 1) %>% 
  ungroup() %>% 
  select(person, most_likely_to_call_on = person_called_on)

called_on_by <- df_long %>% 
  filter(!is.na(person_))
  
```

```{r}
df_long <- df %>% 
  pivot_longer(cols = Brian:Zach, names_to = "person", values_to = "order") %>%
  #filter(date < "2021-02-08") %>% 
  mutate(order = as.numeric(order)) %>% 
  filter(person != "Hala" & person != "Divine" & person != "Zach") %>%
  filter(order < 9) %>% 
  arrange(date, time, order) %>% 
  group_by(date, time) %>% 
  mutate(person_called_on = lead(person)) %>%
  ungroup() %>% 
  mutate(person_called_on_per_meeting = length(person)) %>% 
  count(person, person_called_on)

# denominator for n so we have proportion of times brian called on any one person
# but really need this specific for each pairing- number fo meetings where brian and emi were both present
denom <- data.frame(
  Brian = length(df$Brian[!is.na(df$Brian)]),
  Carly = length(df$Carly[!is.na(df$Carly)]),
  David = length(df$David[!is.na(df$David)]),
  Emi = length(df$Emi[!is.na(df$Emi)]),
  Jeff = length(df$Jeff[!is.na(df$Jeff)]),
  Kelsey = length(df$Kelsey[!is.na(df$Kelsey)]),
  Marissa = length(df$Marissa[!is.na(df$Marissa)]),
  Shannon = length(df$Shannon[!is.na(df$Shannon)])
  ) %>% 
  pivot_longer(cols = Brian:Shannon, names_to = "person", values_to = "denom")

d <- df_long %>% 
  filter(!is.na(person_called_on)) %>% 
  filter(n > 1) %>% 
  left_join(denom) %>% 
  mutate(pct = 100*n/denom)

ggplot(data = d, aes(x=person_called_on, y=person, fill=pct)) + 
  geom_tile(color = "white") +
  scale_fill_gradient2(low = "blue", high = "red", mid = "white",
                       midpoint = 15, limit = c(0, 35)) +
  theme_bw()
```


